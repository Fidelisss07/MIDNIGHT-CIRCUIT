<!DOCTYPE html>
<html class="dark" lang="pt">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comunidade - Midnight Circuit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    <link rel="stylesheet" href="style.css">
    <script src="utils.js"></script>
    <script>tailwind.config={darkMode:"class",theme:{extend:{colors:{primary:"rgb(var(--primary) / <alpha-value>)", "background-dark":"var(--bg-dark)", "surface-dark":"var(--surface)", "surface-light":"#1E1E1E"},fontFamily:{"display":["Space Grotesk","sans-serif"]}}}}</script>
</head>
<body class="bg-background-dark text-gray-200 overflow-hidden">

<div class="relative flex h-screen w-full">
    <aside class="hidden md:flex flex-col items-center w-20 h-full border-r border-white/10 bg-black/50 backdrop-blur-md py-6 z-20">
        <a class="mb-10 text-primary" href="feed.html"><span class="material-symbols-outlined text-4xl">directions_car</span></a>
        <nav class="flex flex-col gap-8 w-full px-2">
            <a href="feed.html" class="flex justify-center p-3 rounded-xl text-gray-500 hover:text-white transition-colors"><span class="material-symbols-outlined">home</span></a>
            <a href="comunidades-hub.html" class="flex justify-center p-3 rounded-xl bg-primary/20 text-primary"><span class="material-symbols-outlined">groups</span></a>
            <a href="perfil.html" class="flex justify-center p-3 rounded-xl text-gray-500 hover:text-white transition-colors"><span class="material-symbols-outlined">person</span></a>
        </nav>
    </aside>

    <main class="flex-1 h-full overflow-y-auto relative no-scrollbar bg-background-dark flex flex-col">
        <div class="h-40 md:h-64 w-full bg-cover bg-center relative" id="com-banner">
            <div class="absolute inset-0 bg-gradient-to-t from-background-dark to-transparent"></div>
            <a href="comunidades-hub.html" class="absolute top-4 left-4 bg-black/50 hover:bg-black text-white px-4 py-2 rounded-full flex items-center gap-2 text-sm backdrop-blur-sm transition-all"><span class="material-symbols-outlined text-sm">arrow_back</span> Voltar</a>
        </div>

        <div class="max-w-6xl mx-auto px-4 md:px-8 relative -top-12 w-full">
            <div class="flex flex-col md:flex-row items-end md:items-center gap-6 mb-6">
                <div class="w-24 h-24 rounded-2xl border-4 border-background-dark bg-black bg-cover shadow-2xl" id="com-avatar"></div>
                <div class="flex-1">
                    <h1 class="text-2xl md:text-4xl font-bold text-white mb-1" id="com-nome">...</h1>
                    <p class="text-gray-400 text-sm line-clamp-1" id="com-desc">...</p>
                </div>
            </div>

            <div class="flex gap-6 border-b border-white/10 mb-6">
                <button onclick="mudarAba('discussao')" id="tab-discussao" class="pb-3 border-b-2 border-primary text-white font-bold transition-all">Discuss√£o</button>
                <button onclick="mudarAba('tuners')" id="tab-tuners" class="pb-3 border-b-2 border-transparent text-gray-500 hover:text-white transition-all">Tuners</button>
            </div>

            <div id="area-discussao">
                <div class="bg-surface-dark border border-white/10 p-4 rounded-xl mb-6 flex gap-4 items-center cursor-pointer hover:bg-white/5 transition-all" onclick="document.getElementById('modal-criar').classList.remove('hidden')">
                    <div class="w-10 h-10 rounded-full bg-cover border border-white/10" id="meu-avatar-mini"></div>
                    <div class="flex-1 bg-black/30 h-10 rounded-full flex items-center px-4 text-gray-500 text-sm">Come√ßa uma discuss√£o...</div>
                    <button class="text-primary"><span class="material-symbols-outlined">send</span></button>
                </div>
                <div id="lista-topicos" class="space-y-4 pb-20"></div>
            </div>

            <div id="area-tuners" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20"></div>
        </div>
    </main>

    <aside class="hidden lg:flex flex-col w-80 h-full bg-surface-dark border-l border-white/5 p-6 z-10">
        <h3 class="text-white font-bold mb-4 text-xs uppercase text-gray-500">Staff do Clube</h3>
        <div id="lista-staff" class="space-y-4 mb-8"></div>
    </aside>
</div>

<div id="modal-criar" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4">
    <div class="bg-surface-dark w-full max-w-2xl rounded-2xl border border-white/10 p-6 shadow-2xl">
        <h2 class="text-xl font-bold text-white mb-4">Novo T√≥pico</h2>
        <input type="text" id="titulo-topico" placeholder="T√≠tulo" class="w-full bg-background-dark border border-white/10 rounded-lg p-3 text-white mb-4">
        <textarea id="conteudo-topico" placeholder="Mensagem..." class="w-full bg-background-dark border border-white/10 rounded-lg p-3 text-white h-32 resize-none"></textarea>
        <div class="flex justify-end gap-3"><button onclick="document.getElementById('modal-criar').classList.add('hidden')" class="px-4 py-2 text-gray-400">Cancelar</button><button onclick="enviarTopico()" class="px-6 py-2 bg-primary text-white rounded-lg font-bold">Publicar</button></div>
    </div>
</div>

<script>
    const USUARIO = verificarLogin();
    const params = new URLSearchParams(window.location.search);
    const CID = params.get('id');
    if(!CID) window.location.href='comunidades-hub.html';

    document.getElementById('meu-avatar-mini').style.backgroundImage = `url('${USUARIO.avatar}')`;
    let comunidadeAtual = {}, souDono = false, souAdmin = false;

    async function init() {
        const res = await fetch(`${URL_SERVIDOR}/comunidades`);
        const todos = await res.json();
        comunidadeAtual = todos.find(c => c.id == CID);
        if(!comunidadeAtual) { alert("Erro: Comunidade n√£o encontrada."); window.location.href='comunidades-hub.html'; return; }

        souDono = comunidadeAtual.dono === USUARIO.email;
        souAdmin = souDono || (comunidadeAtual.admins && comunidadeAtual.admins.includes(USUARIO.email));

        document.getElementById('com-nome').innerText = comunidadeAtual.nome;
        document.getElementById('com-desc').innerText = comunidadeAtual.descricao;
        document.getElementById('com-avatar').style.backgroundImage = `url('${comunidadeAtual.imagem}')`;
        document.getElementById('com-banner').style.backgroundImage = `url('${comunidadeAtual.imagem}')`;

        carregarTopicos();
        carregarMembros();
    }

    async function carregarTopicos() {
        const res = await fetch(`${URL_SERVIDOR}/topicos/${CID}`);
        const topicos = await res.json();
        const lista = document.getElementById('lista-topicos');
        lista.innerHTML = '';

        if(topicos.length === 0) { lista.innerHTML = '<p class="text-center text-gray-500 py-10">Sem t√≥picos.</p>'; return; }

        topicos.reverse().forEach(t => {
            let sty="text-gray-300", badge="";
            if(t.autor===comunidadeAtual.dono) { sty="text-yellow-500 font-bold"; badge="üëë"; }
            else if(comunidadeAtual.admins?.includes(t.autorEmail)) { sty="text-blue-400 font-bold"; badge="üõ°Ô∏è"; }
            
            let del = souAdmin ? `<button onclick="apagarTopico(${t.id})" class="text-red-500 ml-auto text-xs font-bold hover:underline">APAGAR</button>` : "";

            lista.innerHTML += `
                <div class="bg-surface-dark border border-white/5 rounded-xl p-5 hover:border-white/20 transition-colors">
                    <div class="flex items-center gap-2 text-xs text-gray-500 mb-3">
                        <img src="${t.avatar}" class="w-6 h-6 rounded-full border border-white/10">
                        <span class="${sty}">${badge} ${t.autor}</span>
                        <span>‚Ä¢ Recente</span>
                        ${del}
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2">${t.titulo}</h3>
                    <p class="text-gray-400 text-sm mb-4">${t.conteudo}</p>
                    <div class="flex items-center gap-6 mt-2 border-t border-white/5 pt-3">
                        <button onclick="darLike(${t.id},this)" class="flex items-center gap-2 text-gray-500 hover:text-primary"><span class="material-symbols-outlined text-lg">favorite</span> ${t.likes||0}</button>
                    </div>
                </div>`;
        });
    }

    async function carregarMembros() {
        const ru = await fetch(`${URL_SERVIDOR}/usuarios`);
        const tu = await ru.json();
        const lt = document.getElementById('area-tuners');
        const ls = document.getElementById('lista-staff');
        lt.innerHTML = ''; ls.innerHTML = '';

        (comunidadeAtual.membros || []).forEach(e => {
            const u = tu.find(x => x.email === e);
            if(!u) return;

            const isD = e === comunidadeAtual.dono;
            const isA = comunidadeAtual.admins?.includes(e);
            let cg="Membro", clr="text-gray-500", brd="border-transparent";
            
            if(isD) { cg="Dono"; clr="text-yellow-500"; brd="border-yellow-500"; }
            else if(isA) { cg="Admin"; clr="text-blue-400"; brd="border-blue-400"; }

            let acts = "";
            if (souDono && !isD) {
                if (!isA) acts += `<button onclick="gm('promover','${e}')" class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded hover:bg-blue-500 hover:text-white mr-2">Promover</button>`;
                acts += `<button onclick="gm('expulsar','${e}')" class="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded hover:bg-red-500 hover:text-white">Expulsar</button>`;
            } else if (souAdmin && !isD && !isA) {
                acts += `<button onclick="gm('expulsar','${e}')" class="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded hover:bg-red-500 hover:text-white">Expulsar</button>`;
            }

            lt.innerHTML += `
                <div class="flex items-center gap-3 bg-surface-dark p-4 rounded-xl border border-white/5">
                    <img src="${u.avatar}" class="w-10 h-10 rounded-full border-2 ${brd}">
                    <div class="flex-1"><p class="text-white font-bold text-sm">${u.nome}</p><p class="text-xs ${clr} font-bold uppercase">${cg}</p></div>
                    <div>${acts}</div>
                </div>`;
            
            if(isD || isA) ls.innerHTML += `<div class="flex items-center gap-3"><img src="${u.avatar}" class="w-8 h-8 rounded-full border ${brd}"><div><p class="text-white text-sm font-bold">${u.nome}</p><p class="${clr} text-xs">${cg}</p></div></div>`;
        });
    }

    async function gm(a, e) {
        if(!confirm("Certeza?")) return;
        await fetch(`${URL_SERVIDOR}/comunidades/${a}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ idComunidade: CID, emailAlvo: e }) });
        location.reload();
    }

    async function enviarTopico() {
        const t = document.getElementById('titulo-topico').value; const c = document.getElementById('conteudo-topico').value;
        if(!t) return;
        const f = new FormData();
        f.append('comunidadeId', CID); f.append('titulo', t); f.append('conteudo', c); f.append('autor', USUARIO.nome); f.append('emailAutor', USUARIO.email); f.append('avatar', USUARIO.avatar);
        await fetch(`${URL_SERVIDOR}/topicos`, { method: 'POST', body: f });
        document.getElementById('modal-criar').classList.add('hidden'); carregarTopicos();
    }

    async function apagarTopico(id) { if(confirm("Apagar?")) { await fetch(`${URL_SERVIDOR}/topicos/${id}`, { method: 'DELETE' }); carregarTopicos(); } }
    async function darLike(id, btn) { const r = await fetch(`${URL_SERVIDOR}/topicos/like/${id}`, { method: 'POST' }); if(r.ok) { btn.querySelector('span').classList.add('text-primary', 'animar-like'); btn.querySelector('span').style.fontVariationSettings = "'FILL' 1"; carregarTopicos(); } }

    function mudarAba(a) {
        const ad = document.getElementById('area-discussao'); const at = document.getElementById('area-tuners');
        const td = document.getElementById('tab-discussao'); const tt = document.getElementById('tab-tuners');
        if(a === 'discussao') { ad.classList.remove('hidden'); at.classList.add('hidden'); td.classList.replace('border-transparent','border-primary'); tt.classList.replace('border-primary','border-transparent'); }
        else { ad.classList.add('hidden'); at.classList.remove('hidden'); tt.classList.replace('border-transparent','border-primary'); td.classList.replace('border-primary','border-transparent'); }
    }

    init();
</script>
</body>
</html>